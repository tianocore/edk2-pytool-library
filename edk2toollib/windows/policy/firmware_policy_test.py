# @file
# UnitTest for firmware_policy.py
#
# Copyright (c) Microsoft Corporation
#
# SPDX-License-Identifier: BSD-2-Clause-Patent
##
import unittest
import secrets
import io
from edk2toollib.windows.policy.firmware_policy import FirmwarePolicy


class FirmwarePolicyTest(unittest.TestCase):

    TEST_DEVICEID_C2E28 = bytearray.fromhex(
        """02 00 01 00 00 00 2E D8 DA 0C 39 D8 54 47 89 A1 84 4A B2 82 31 2B 00
        00 10 02 00 00 00 00 01 00 00 00 00 81 00 00 00 00 0C 00 00 00 1E 00 00
        00 0A 00 44 00 65 00 62 00 75 00 67 00 10 00 44 00 65 00 76 00 69 00 63
        00 65 00 49 00 44 00 05 00 F6 AE 8C 94 3A 8C E2 C2""")

    # Policy-DeviceId-C2E28C3A948CAEF6.p7b
    TEST_POLICY_DEVICEID_C2E28 = bytearray.fromhex(
        """30 82 0D 8F 06 09 2A 86 48 86 F7 0D 01 07 02 A0 82 0D 80 30 82 0D 7C 02 01
        01 31 0F 30 0D 06 09 60 86 48 01 65 03 04 02 01 05 00 30 67 06 09 2B 06
        01 04 01 82 37 4F 01 A0 5A 04 58 02 00 01 00 00 00 2E D8 DA 0C 39 D8 54
        47 89 A1 84 4A B2 82 31 2B 00 00 10 02 00 00 00 00 01 00 00 00 00 81 00
        00 00 00 0C 00 00 00 1E 00 00 00 0A 00 44 00 65 00 62 00 75 00 67 00 10
        00 44 00 65 00 76 00 69 00 63 00 65 00 49 00 44 00 05 00 F6 AE 8C 94 3A
        8C E2 C2 A0 82 0A E2 30 82 05 03 30 82 03 EB A0 03 02 01 02 02 13 33 00
        00 00 24 18 FC 0B 68 9E 73 99 D0 00 00 00 00 00 24 30 0D 06 09 2A 86 48
        86 F7 0D 01 01 0B 05 00 30 81 84 31 0B 30 09 06 03 55 04 06 13 02 55 53
        31 13 30 11 06 03 55 04 08 13 0A 57 61 73 68 69 6E 67 74 6F 6E 31 10 30
        0E 06 03 55 04 07 13 07 52 65 64 6D 6F 6E 64 31 1E 30 1C 06 03 55 04 0A
        13 15 4D 69 63 72 6F 73 6F 66 74 20 43 6F 72 70 6F 72 61 74 69 6F 6E 31
        2E 30 2C 06 03 55 04 03 13 25 4D 69 63 72 6F 73 6F 66 74 20 57 69 6E 64
        6F 77 73 20 50 72 6F 64 75 63 74 69 6F 6E 20 50 43 41 20 32 30 31 31 30
        1E 17 0D 31 33 30 36 31 37 32 31 34 33 33 38 5A 17 0D 31 34 30 39 31 37
        32 31 34 33 33 38 5A 30 70 31 0B 30 09 06 03 55 04 06 13 02 55 53 31 13
        30 11 06 03 55 04 08 13 0A 57 61 73 68 69 6E 67 74 6F 6E 31 10 30 0E 06
        03 55 04 07 13 07 52 65 64 6D 6F 6E 64 31 1E 30 1C 06 03 55 04 0A 13 15
        4D 69 63 72 6F 73 6F 66 74 20 43 6F 72 70 6F 72 61 74 69 6F 6E 31 1A 30
        18 06 03 55 04 03 13 11 4D 69 63 72 6F 73 6F 66 74 20 57 69 6E 64 6F 77
        73 30 82 01 22 30 0D 06 09 2A 86 48 86 F7 0D 01 01 01 05 00 03 82 01 0F
        00 30 82 01 0A 02 82 01 01 00 D9 CE 62 A4 93 12 5C 45 CB 53 46 D0 41 F4
        3A DC 59 C8 55 7F 2C C3 C0 EA 9D 78 A0 55 84 D1 97 E8 C8 A1 A8 43 E4 7F
        F7 A8 0E 34 B5 DA 44 C5 70 92 8A 4B 7F F3 05 5F B3 BD EA E5 A8 F1 8B FC
        DB 3C 7D 5D D3 9F 0F 82 B3 9E A8 18 53 B8 91 A1 1F 41 19 42 A5 81 93 6E
        AE 73 69 13 72 53 53 03 4F E8 48 78 B8 8E F0 31 95 B8 CC 23 5C 74 F3 26
        9D 9D B4 C8 16 E2 99 7D D9 88 E6 F5 01 60 30 44 87 D7 C6 E7 3B 98 E8 8B
        D8 04 0A D4 56 F1 54 EA 5F 4F D8 8F 0D 8C 07 E3 7F E2 40 28 85 A4 3A BD
        5B 68 FA F7 69 74 AC 9C 71 5E 69 22 0B C5 2B FB 12 43 54 F2 9D C9 FD B0
        52 53 62 B8 6A 11 3C C1 B5 D2 5E 76 1F C0 AB BC C0 BC 0F CB 98 3B 70 68
        7F 16 87 EF F1 7C A9 F9 B4 61 F1 9B 06 FA 56 2B F1 54 A6 96 27 FB F5 10
        CD 27 B8 0E 12 FA 87 DD 1D 15 5E 7F CA AD B6 D0 FA C7 8D 1C 54 E6 35 45
        26 0F 02 03 01 00 01 A3 82 01 7F 30 82 01 7B 30 1F 06 03 55 1D 25 04 18
        30 16 06 08 2B 06 01 05 05 07 03 03 06 0A 2B 06 01 04 01 82 37 0A 03 06
        30 1D 06 03 55 1D 0E 04 16 04 14 A8 90 49 53 DC 95 20 69 43 28 FD 28 26
        6F DE 33 73 E4 26 81 30 51 06 03 55 1D 11 04 4A 30 48 A4 46 30 44 31 0D
        30 0B 06 03 55 04 0B 13 04 4D 4F 50 52 31 33 30 31 06 03 55 04 05 13 2A
        33 31 36 31 32 2B 30 39 61 36 64 35 66 33 2D 38 31 32 35 2D 34 31 36 61
        2D 62 39 62 31 2D 34 34 37 64 32 63 32 35 61 66 61 39 30 1F 06 03 55 1D
        23 04 18 30 16 80 14 A9 29 02 39 8E 16 C4 97 78 CD 90 F9 9E 4F 9A E1 7C
        55 AF 53 30 54 06 03 55 1D 1F 04 4D 30 4B 30 49 A0 47 A0 45 86 43 68 74
        74 70 3A 2F 2F 77 77 77 2E 6D 69 63 72 6F 73 6F 66 74 2E 63 6F 6D 2F 70
        6B 69 6F 70 73 2F 63 72 6C 2F 4D 69 63 57 69 6E 50 72 6F 50 43 41 32 30
        31 31 5F 32 30 31 31 2D 31 30 2D 31 39 2E 63 72 6C 30 61 06 08 2B 06 01
        05 05 07 01 01 04 55 30 53 30 51 06 08 2B 06 01 05 05 07 30 02 86 45 68
        74 74 70 3A 2F 2F 77 77 77 2E 6D 69 63 72 6F 73 6F 66 74 2E 63 6F 6D 2F
        70 6B 69 6F 70 73 2F 63 65 72 74 73 2F 4D 69 63 57 69 6E 50 72 6F 50 43
        41 32 30 31 31 5F 32 30 31 31 2D 31 30 2D 31 39 2E 63 72 74 30 0C 06 03
        55 1D 13 01 01 FF 04 02 30 00 30 0D 06 09 2A 86 48 86 F7 0D 01 01 0B 05
        00 03 82 01 01 00 78 26 9C 4B 43 26 8A FB C7 32 9A 21 65 3F DF 54 27 C5
        1D 15 6B D9 B2 BE 4F C3 CE 06 C9 FE 48 6A D2 8F A1 A5 56 98 AC C8 61 77
        33 A5 D9 B6 8B 3F 69 AB 82 D8 D6 08 57 A0 CF 33 04 34 70 3B 2A F4 3B 30
        58 EE C8 91 F8 95 15 A9 AC F8 C2 9A EB DC AB C8 67 16 30 A1 D2 2F A5 17
        20 AB 95 39 3C 38 8E 3F BE D2 D4 2E CA 2B CE 4F 3A C0 3B E5 BE 68 EC FE
        7F 44 A6 D3 87 17 82 AB D7 CC 3F 8C 22 30 05 36 BD 24 A1 39 34 47 4B C0
        CF C2 F1 47 99 91 B9 91 F3 28 CB 5A 80 D0 6C 10 46 A9 24 9B 8D D8 74 7B
        3C 87 E5 49 46 F2 8C 0B DF 14 C0 42 56 62 64 FB F9 47 58 59 B2 21 D0 43
        46 03 AB 5F 65 55 51 43 7B E8 EB 21 19 2F 14 3D 17 3B 04 2F 13 9C E5 53
        88 8C F0 53 4F 9D 2F 09 0C 1E DB F1 0D EF 82 7A 27 4A FE EB A1 0C 2B 47
        25 B0 62 8A 27 22 D5 F2 09 BE 4F 9E 3D 2D 81 04 A8 96 DF 82 07 2D 30 82
        05 D7 30 82 03 BF A0 03 02 01 02 02 0A 61 07 76 56 00 00 00 00 00 08 30
        0D 06 09 2A 86 48 86 F7 0D 01 01 0B 05 00 30 81 88 31 0B 30 09 06 03 55
        04 06 13 02 55 53 31 13 30 11 06 03 55 04 08 13 0A 57 61 73 68 69 6E 67
        74 6F 6E 31 10 30 0E 06 03 55 04 07 13 07 52 65 64 6D 6F 6E 64 31 1E 30
        1C 06 03 55 04 0A 13 15 4D 69 63 72 6F 73 6F 66 74 20 43 6F 72 70 6F 72
        61 74 69 6F 6E 31 32 30 30 06 03 55 04 03 13 29 4D 69 63 72 6F 73 6F 66
        74 20 52 6F 6F 74 20 43 65 72 74 69 66 69 63 61 74 65 20 41 75 74 68 6F
        72 69 74 79 20 32 30 31 30 30 1E 17 0D 31 31 31 30 31 39 31 38 34 31 34
        32 5A 17 0D 32 36 31 30 31 39 31 38 35 31 34 32 5A 30 81 84 31 0B 30 09
        06 03 55 04 06 13 02 55 53 31 13 30 11 06 03 55 04 08 13 0A 57 61 73 68
        69 6E 67 74 6F 6E 31 10 30 0E 06 03 55 04 07 13 07 52 65 64 6D 6F 6E 64
        31 1E 30 1C 06 03 55 04 0A 13 15 4D 69 63 72 6F 73 6F 66 74 20 43 6F 72
        70 6F 72 61 74 69 6F 6E 31 2E 30 2C 06 03 55 04 03 13 25 4D 69 63 72 6F
        73 6F 66 74 20 57 69 6E 64 6F 77 73 20 50 72 6F 64 75 63 74 69 6F 6E 20
        50 43 41 20 32 30 31 31 30 82 01 22 30 0D 06 09 2A 86 48 86 F7 0D 01 01
        01 05 00 03 82 01 0F 00 30 82 01 0A 02 82 01 01 00 DD 0C BB A2 E4 2E 09
        E3 E7 C5 F7 96 69 BC 00 21 BD 69 33 33 EF AD 04 CB 54 80 EE 06 83 BB C5
        20 84 D9 F7 D2 8B F3 38 B0 AB A4 AD 2D 7C 62 79 05 FF E3 4A 3F 04 35 20
        70 E3 C4 E7 6B E0 9C C0 36 75 E9 8A 31 DD 8D 70 E5 DC 37 B5 74 46 96 28
        5B 87 60 23 2C BF DC 47 A5 67 F7 51 27 9E 72 EB 07 A6 C9 B9 1E 3B 53 35
        7C E5 D3 EC 27 B9 87 1C FE B9 C9 23 09 6F A8 46 91 C1 6E 96 3C 41 D3 CB
        A3 3F 5D 02 6A 4D EC 69 1F 25 28 5C 36 FF FD 43 15 0A 94 E0 19 B4 CF DF
        C2 12 E2 C2 5B 27 EE 27 78 30 8B 5B 2A 09 6B 22 89 53 60 16 2C C0 68 1D
        53 BA EC 49 F3 9D 61 8C 85 68 09 73 44 5D 7D A2 54 2B DD 79 F7 15 CF 35
        5D 6C 1C 2B 5C CE BC 9C 23 8B 6F 6E B5 26 D9 36 13 C3 4F D6 27 AE B9 32
        3B 41 92 2C E1 C7 CD 77 E8 AA 54 4E F7 5C 0B 04 87 65 B4 43 18 A8 B2 E0
        6D 19 77 EC 5A 24 FA 48 03 02 03 01 00 01 A3 82 01 43 30 82 01 3F 30 10
        06 09 2B 06 01 04 01 82 37 15 01 04 03 02 01 00 30 1D 06 03 55 1D 0E 04
        16 04 14 A9 29 02 39 8E 16 C4 97 78 CD 90 F9 9E 4F 9A E1 7C 55 AF 53 30
        19 06 09 2B 06 01 04 01 82 37 14 02 04 0C 1E 0A 00 53 00 75 00 62 00 43
        00 41 30 0B 06 03 55 1D 0F 04 04 03 02 01 86 30 0F 06 03 55 1D 13 01 01
        FF 04 05 30 03 01 01 FF 30 1F 06 03 55 1D 23 04 18 30 16 80 14 D5 F6 56
        CB 8F E8 A2 5C 62 68 D1 3D 94 90 5B D7 CE 9A 18 C4 30 56 06 03 55 1D 1F
        04 4F 30 4D 30 4B A0 49 A0 47 86 45 68 74 74 70 3A 2F 2F 63 72 6C 2E 6D
        69 63 72 6F 73 6F 66 74 2E 63 6F 6D 2F 70 6B 69 2F 63 72 6C 2F 70 72 6F
        64 75 63 74 73 2F 4D 69 63 52 6F 6F 43 65 72 41 75 74 5F 32 30 31 30 2D
        30 36 2D 32 33 2E 63 72 6C 30 5A 06 08 2B 06 01 05 05 07 01 01 04 4E 30
        4C 30 4A 06 08 2B 06 01 05 05 07 30 02 86 3E 68 74 74 70 3A 2F 2F 77 77
        77 2E 6D 69 63 72 6F 73 6F 66 74 2E 63 6F 6D 2F 70 6B 69 2F 63 65 72 74
        73 2F 4D 69 63 52 6F 6F 43 65 72 41 75 74 5F 32 30 31 30 2D 30 36 2D 32
        33 2E 63 72 74 30 0D 06 09 2A 86 48 86 F7 0D 01 01 0B 05 00 03 82 02 01
        00 14 FC 7C 71 51 A5 79 C2 6E B2 EF 39 3E BC 3C 52 0F 6E 2B 3F 10 13 73
        FE A8 68 D0 48 A6 34 4D 8A 96 05 26 EE 31 46 90 61 79 D6 FF 38 2E 45 6B
        F4 C0 E5 28 B8 DA 1D 8F 8A DB 09 D7 1A C7 4C 0A 36 66 6A 8C EC 1B D7 04
        90 A8 18 17 A4 9B B9 E2 40 32 36 76 C4 C1 5A C6 BF E4 04 C0 EA 16 D3 AC
        C3 68 EF 62 AC DD 54 6C 50 30 58 A6 EB 7C FE 94 A7 4E 8E F4 EC 7C 86 73
        57 C2 52 21 73 34 5A F3 A3 8A 56 C8 04 DA 07 09 ED F8 8B E3 CE F4 7E 8E
        AE F0 F6 0B 8A 08 FB 3F C9 1D 72 7F 53 B8 EB BE 63 E0 E3 3D 31 65 B0 81
        E5 F2 AC CD 16 A4 9F 3D A8 B1 9B C2 42 D0 90 84 5F 54 1D FF 89 EA BA 1D
        47 90 6F B0 73 4E 41 9F 40 9F 5F E5 A1 2A B2 11 91 73 8A 21 28 F0 CE DE
        73 39 5F 3E AB 5C 60 EC DF 03 10 A8 D3 09 E9 F4 F6 96 85 B6 7F 51 88 66
        47 19 8D A2 B0 12 3D 81 2A 68 05 77 BB 91 4C 62 7B B6 C1 07 C7 BA 7A 87
        34 03 0E 4B 62 7A 99 E9 CA FC CE 4A 37 C9 2D A4 57 7C 1C FE 3D DC B8 0F
        5A FA D6 C4 B3 02 85 02 3A EA B3 D9 6E E4 69 21 37 DE 81 D1 F6 75 19 05
        67 D3 93 57 5E 29 1B 39 C8 EE 2D E1 CD E4 45 73 5B D0 D2 CE 7A AB 16 19
        82 46 58 D0 5E 9D 81 B3 67 AF 6C 35 F2 BC E5 3F 24 E2 35 A2 0A 75 06 F6
        18 56 99 D4 78 2C D1 05 1B EB D0 88 01 9D AA 10 F1 05 DF BA 7E 2C 63 B7
        06 9B 23 21 C4 F9 78 6C E2 58 17 06 36 2B 91 12 03 CC A4 D9 F2 2D BA F9
        94 9D 40 ED 18 45 F1 CE 8A 5C 6B 3E AB 03 D3 70 18 2A 0A 6A E0 5F 47 D1
        D5 63 0A 32 F2 AF D7 36 1F 2A 70 5A E5 42 59 08 71 4B 57 BA 7E 83 81 F0
        21 3C F4 1C C1 C5 B9 90 93 0E 88 45 93 86 E9 B1 20 99 BE 98 CB C5 95 A4
        5D 62 D6 A0 63 08 20 BD 75 10 77 7D 3D F3 45 B9 9F 97 9F CB 57 80 6F 33
        A9 04 CF 77 A4 62 1C 59 7E 31 82 02 15 30 82 02 11 02 01 01 30 81 9C 30
        81 84 31 0B 30 09 06 03 55 04 06 13 02 55 53 31 13 30 11 06 03 55 04 08
        13 0A 57 61 73 68 69 6E 67 74 6F 6E 31 10 30 0E 06 03 55 04 07 13 07 52
        65 64 6D 6F 6E 64 31 1E 30 1C 06 03 55 04 0A 13 15 4D 69 63 72 6F 73 6F
        66 74 20 43 6F 72 70 6F 72 61 74 69 6F 6E 31 2E 30 2C 06 03 55 04 03 13
        25 4D 69 63 72 6F 73 6F 66 74 20 57 69 6E 64 6F 77 73 20 50 72 6F 64 75
        63 74 69 6F 6E 20 50 43 41 20 32 30 31 31 02 13 33 00 00 00 24 18 FC 0B
        68 9E 73 99 D0 00 00 00 00 00 24 30 0D 06 09 60 86 48 01 65 03 04 02 01
        05 00 A0 4B 30 18 06 09 2A 86 48 86 F7 0D 01 09 03 31 0B 06 09 2B 06 01
        04 01 82 37 4F 01 30 2F 06 09 2A 86 48 86 F7 0D 01 09 04 31 22 04 20 C5
        90 2F B4 18 90 76 D6 F4 5A EE 0B 7F 26 5F 40 5C FE 09 51 5A BE FA C5 4A
        B3 52 9B 3D 82 BB 9F 30 0D 06 09 2A 86 48 86 F7 0D 01 01 01 05 00 04 82
        01 00 72 4B 8C DA 85 D2 1E C0 71 68 99 77 79 2E 51 78 52 4B F6 9F 11 31
        E7 D5 F2 00 10 CD 94 B9 D3 C7 67 B4 EA F4 2B 62 04 02 93 55 79 97 A2 D0
        EA 57 F0 81 56 42 1E 10 5E 18 79 8F 59 AB DB 86 EC A3 74 37 48 FE 91 3B
        48 7C 94 CF FE D3 D6 44 0B 94 D2 0C 6F 12 20 9C 92 77 EB 3A 8C 84 BB 81
        93 AD 5A FF F8 2B 27 C8 9C 61 85 6C 1A D5 2B B6 1C D5 7A EA 86 5C 08 A0
        CB 51 21 49 4B F2 04 36 5F 38 48 80 D0 CD FC E5 4D 6A 19 0A 17 86 8D E7
        4B 32 09 62 15 95 36 61 1C 07 12 B8 D7 64 FA CE 74 84 42 20 18 77 A5 F4
        4E ED 42 5C 64 BD 57 99 E7 C3 7E 2D 0C 8F FE 38 7B 68 0C 78 DF 3D E9 30
        10 EA D4 1E 24 E1 60 F1 89 92 59 B4 8C F5 F6 8C F9 CE 8C EB 99 D6 35 0A
        03 0E FB 88 4A 01 54 8C 20 84 18 F5 49 6B 8B 96 D3 55 45 0C 99 79 23 28
        51 18 C2 4B 96 02 74 79 86 44 FB B5 98 59 69 E2 80 DE""")

    def test_basic_decode(self):
        inp = io.BytesIO(FirmwarePolicyTest.TEST_DEVICEID_C2E28)
        policyManuf = FirmwarePolicy(inp)
        policyManuf.Print()

    def test_basic_create_encode_decode_roundtrip(self):

        policyManuf = FirmwarePolicy()
        nonce = secrets.randbits(64)
        TargetInfo = {
            # EV Certificate Subject CN="<foo>", recommend matches SmbiosSystemManufacturer,
            # SMBIOS Table 1, offset 04h (System Manufacturer)
            'Manufacturer': 'Contoso Computers, LLC',
            # SmbiosSystemProductName, SMBIOS Table 1, offset 05h (System Product Name)
            'Product': 'Laptop Foo',
            # SmbiosSystemSerialNumber, SMBIOS System Information (Type 1 Table) -> Serial Number
            'SerialNumber': 'F0013-000243546-X02',
            # Yours to define, or not use (NULL string), ODM name is suggested
            'OEM_01': 'ODM Foo',
            # Yours to define, or not use (NULL string)
            'OEM_02': '',
            # The following is randomly generated by the device
            'Nonce': nonce}
        policyManuf.SetDeviceTarget(TargetInfo)

        policy = \
            FirmwarePolicy.FW_POLICY_VALUE_ACTION_SECUREBOOT_CLEAR \
            + FirmwarePolicy.FW_POLICY_VALUE_ACTION_TPM_CLEAR
        policyManuf.SetDevicePolicy(policy=policy)

        first_output = io.BytesIO()
        policyManuf.Serialize(output=first_output)
        policyManuf.Print()

        first_output.seek(0)
        testPolicy = FirmwarePolicy(fs=first_output)
        second_output = io.BytesIO()
        testPolicy.Serialize(output=second_output)

        self.assertEqual(first_output.getbuffer(), second_output.getbuffer())

        first_output.close()
        second_output.close()
